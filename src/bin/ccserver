#!/usr/bin/env python

import sys
import os
import logging
import json
import getopt

import ccloud

def usage():
    sys.stderr.write('''Usage: {program_name} [-d] [-c FILE] [[HOST:]PORT]
       {program_name} --help
Try `{program_name} --help' for more information.
'''.format(program_name=program_name))


def print_help():
    sys.stderr.write('''Usage: {program_name} [-d] [-c FILE] [[HOST:]PORT]
       {program_name} --help
       
Run the ccloud HTTP server.

Positional arguments:
  HOST              hostname (default: localhost)
  PORT              port (default: 8080)

Optional arguments:
  -c FILE           configuration file (default: config.json)
  -d                print debugging information    
  --help            print this help information

Report bugs to <ccplot-general@lists.sourceforge.net>.
'''.format(program_name=program_name))


if __name__ == "__main__":
    program_name = sys.argv[0]
    logging.basicConfig(format=program_name+': %(message)s', level=logging.INFO)
    os.setpgrp()
    
    config = ccloud.config.default_config
    filename = 'config.json'
    
    # Command line arguments.
    try: opts, args = getopt.getopt(sys.argv[1:], 'c:d', ['help'])
    except getopt.GetoptError as e:
        logging.error(e)
        usage()
        sys.exit(1)
    
    for opt,value in opts:
        if opt == '-d':
            config['debug'] = True
        elif opt == '-c':
            filename = value
        elif opt == '--help':
            print_help()
            sys.exit(0)
    
    if len(args) > 1:
        usage()
        sys.exit(1)
    
    try:
        with open(filename) as fp:
            config.update(json.load(fp))
    except ValueError as e:
        logging.error('%s: %s' % (filename, e))
        sys.exit(1)
    except IOError as e:
        logging.error('%s: %s' % (e.filename, e.strerror))
        sys.exit(1)
    
    host = None
    port = None
    if len(args) == 1:
        i = args[0].rfind(':')
        if i == -1: port = args[0]
        else:
            host = args[0][:i]
            port = args[0][(i+1):]
    
    if host != None: config['host'] = host
    try:
        if port != None: config['port'] = int(port)
    except ValueError:
        logging.error('Invalid port number %s' % args[0][i+1:])
        sys.exit(1)
    
    try: ccloud.server.run(config)
    except RuntimeError as e:
        logging.error(e)
        sys.exit(1)
    except KeyboardInterrupt: pass
